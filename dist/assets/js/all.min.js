(function(){var t,e,n,r,a,i,o,s,l,d,c,u,p,g,m,h,f,v,w=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};p=function(t){var e,n,r,a,i;i=[];for(r in t)a=t[r],"randomData"!==r&&(e=$("[name="+r+"]"),"lang"===r||"iterations"===r||"limit"===r?e.val()!==a?i.push(e.val(a)):i.push(void 0):"direction"===r?e.find(":selected").val()!==a.toLowerCase()?i.push(e.val(a.toLowerCase())):i.push(void 0):e.find(":selected").val()!==a?(n=$("<option selected />").val(a).text("Loading..."),e.append(n),e.trigger("change"),i.push(g(e,n,a))):i.push(void 0));return i},g=function(t,e,n){return $.getJSON("https://www.wikidata.org/w/api.php?callback=?",{action:"wbsearchentities",search:n,uselang:$("[name=lang]").val()||History.getState().data.lang||"en",language:$("[name=lang]").val()||History.getState().data.lang||"en",type:n.startsWith("Q")?"item":"property",format:"json",formatversion:2,limit:1}).then(function(r){var a;e.text((null!=(a=r.search)?a[0].label:void 0)||n),e.removeData(),t.trigger("change")})},r=function(t){return t.label||t.text},n=function(t){return'<div><div class="item-name">'+(t.label||t.text)+"</div>"+(t.description?'<div class="item-descrition">'+t.description+"</div>":"")+"</div>"},m=function(t,e,a){return t.select2({placeholder:a,theme:"bootstrap",ajax:{url:"https://www.wikidata.org/w/api.php",dataType:"jsonp",cache:!0,data:function(n){return{action:"wbsearchentities",search:n.term||t.val(),uselang:$("[name=lang]").val()||History.getState().data.lang||"en",language:$("[name=lang]").val()||History.getState().data.lang||"en",type:e,format:"json",formatversion:2,"continue":n.next||0}},processResults:function(t,e){return e.next=t["search-continue"],{results:t.search,pagination:{more:t["search-continue"]}}}},minimumInputLength:1,templateResult:n,templateSelection:r,escapeMarkup:function(t){return t}})},$(function(){var t;return $(".navbar-brand").attr("href",window.location.href.split("?")[0]),$("form").validate({errorPlacement:function(){},highlight:function(t){$(t).parent().addClass("has-error")},unhighlight:function(t){$(t).parent().removeClass("has-error")},rules:{item:{required:!0,regex:/^Q\d+$/},property:{required:!0,regex:/^P\d+$/},lang:{required:!0,minlength:2,regex:/^[a-z-]+$/}}}),$("form").on("submit",h),m($("select[name=item]"),"item","Item, e. g Q42196"),m($("select[name=property]"),"property","Property, e. g P171"),t=s(),History.replaceState(t),p(t),f(),History.Adapter.bind(window,"statechange",f),$("#openSparql").click(d),$("#openSvg").click(c),$("#openWdTree").click(u)}),e={property:"",item:"",lang:"en",direction:"Forward",iterations:0,limit:0},v=["forward","reverse","both"],t=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},h=function(n){var r,a,i,o,s,l,d,c,u,p;if($("form").valid()){l=$(this).find("[name=property] :selected"),a=$(this).find("[name=item] :selected"),o=$(this).find("[name=lang]"),r=$(this).find("[name=direction]"),i=$(this).find("[name=iterations]"),s=$(this).find("[name=limit]"),d={randomData:Math.random(),property:l.val(),item:a.val(),lang:o.val(),direction:t(r.val()),iterations:parseInt(i.val()),limit:parseInt(s.val())},u={};for(c in e)p=e[c],d[c]!==p&&(u[c]=d[c]);return u.direction&&(u.direction=u.direction.toLowerCase()),History.pushState(d,"","?"+$.param(u)),!1}},s=function(){var n,r,a,i,o,s,l;for(a=/\+/g,s=/([^&=]+)=?([^&]*)/g,n=function(t){return decodeURIComponent(t.replace(a," "))},i=window.location.search.substring(1),l={};r=s.exec(i);)l[n(r[1])]=n(r[2]);return{item:l.item||e.item,property:l.property||e.property,lang:l.lang||e.lang,direction:(o=l.direction,w.call(v,o)>=0?t(l.direction):e.direction),iterations:parseInt(l.iterations)||e.iterations,limit:parseInt(l.limit)||e.limit}},o=function(){return"PREFIX wd: <http://www.wikidata.org/entity/>\nPREFIX wdt: <http://www.wikidata.org/prop/direct/>\nPREFIX wikibase: <http://wikiba.se/ontology#>\nPREFIX gas: <http://www.bigdata.com/rdf/gas#>"},i=function(t,e){return null==e&&(e=t.direction),'SELECT ?item ?itemLabel ?parent {\n  { SERVICE gas:service {\n     gas:program gas:gasClass "com.bigdata.rdf.graph.analytics.SSSP" ;\n                 gas:in wd:'+t.item+' ;\n                 gas:traversalDirection "'+e+'" ;\n                 gas:out ?item ;\n                 gas:out1 ?depth ;'+(0===t.iterations?"":"\n                 gas:maxIterations "+t.iterations+" ;")+(0===t.limit?"":"\n                 gas:maxVisited "+t.limit+" ;")+"\n                 gas:linkType wdt:"+t.property+" .\n    }\n  } .\n  OPTIONAL { ?item wdt:"+t.property+' ?parent }\n  SERVICE wikibase:label {bd:serviceParam wikibase:language "'+t.lang+'" }\n}'},a=function(t){return"Both"!==t.direction?o()+"\n\n"+i(t):o()+"\nSELECT * { {\n"+i(t,"Forward")+"\n} UNION {\n"+i(t,"Reverse")+"\n} }"},l=function(t){var e,n,r,a,i,o,s,l,d,c,u,p,g,m,h,f,v,w,y,x,k;for(e=History.getState().data.item,n=t.results.bindings,g={},d=0,c=n.length;c>d;d++)s=n[d],g[s.item.value]={name:s.itemLabel.value,url:s.item.value};p=function(){var t,e,r,a;for(a=[],t=0,e=n.length;e>t;t++)s=n[t],g[null!=(r=s.parent)?r.value:void 0]&&a.push({source:g[s.item.value],target:g[s.parent.value]});return a}(),y=function(t){return"translate("+t.x+","+t.y+")"},w=function(){u.attr({x1:function(t){return t.source.x},y1:function(t){return t.source.y},x2:function(t){return t.target.x},y2:function(t){return t.target.y}}),r.attr({transform:y}),v.attr({transform:y})},m=function(){var t,e;e=window.innerWidth,t=window.innerHeight-$("nav").outerHeight()-10,h.attr({width:e,height:t}),o.attr({width:e,height:t}),l.size([e,t]).resume()},k=function(){a.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")},x=d3.behavior.zoom().on("zoom",k),l=d3.layout.force(),i=l.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}),l.nodes(d3.values(g)).links(p).linkDistance(30).charge(-200).gravity(.05).on("tick",w).start(),h=d3.select("svg").attr("pointer-events","all"),h.selectAll("*").remove(),h.append("defs").selectAll("marker").data(["direction"]).enter().append("marker").attr({id:function(t){return t},viewBox:"0 -5 10 10",refX:15,markerWidth:6,markerHeight:6,orient:"auto"}).append("path").attr({d:"M0,-5L10,0L0,5"}),f=h.append("g").attr("transform","translate(0,0)").call(x),o=f.append("rect").style("fill","none"),a=f.append("g"),u=a.append("g").selectAll("line").data(l.links()).enter().append("line").attr({"marker-end":"url(#direction)"}),r=a.append("g").selectAll("circle").data(l.nodes()).enter().append("circle").attr({r:6}).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).classed("active",function(t){return t.url.endsWith(e)}).call(i),v=a.append("g").selectAll("text").data(l.nodes()).enter().append("text").attr({x:8,y:".31em"}).text(function(t){return t.name}).on("click",function(t){window.open(t.url)}),m(),d3.select(window).on("resize",m)},$.validator.addMethod("regex",function(t,e,n){var r;return r=!1,this.optional(e)||n.test(t)},"Please check your input."),f=function(){var t,e,n;t=History.getState().data,p(t),e=a(t),t.item&&t.property?($("#main").hide(),$("svg").show(),n=(new Date).getTime(),$.getJSON("https://query.wikidata.org/sparql",{query:e},l).fail(function(t,e,r){var a;a=(new Date).getTime()-n,1e4>a?toastr.error("Something is wrong with SPARQL query syntax"):toastr.error("SPARQL query times out")})):($("#main").show(),$("svg").hide())},d=function(){var t,e;if($("form").valid())return t=History.getState().data,e=a(t),window.open("https://query.wikidata.org/#"+encodeURIComponent(e))},c=function(){var t,e,n;if($("form").valid())return t=new XMLSerializer,e=t.serializeToString($("svg")[0]),e='<?xml version="1.0" standalone="no"?>\r\n'+e,n="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e),window.open(n)},u=function(){var t,e,n,r;if($("form").valid())return t=History.getState().data,r="https://tools.wmflabs.org/wikidata-todo/tree.html?q="+t.item.slice(1),("Reverse"===(e=t.direction)||"Both"===e)&&(r+="&rp="+t.property.slice(1)),("Forward"===(n=t.direction)||"Both"===n)&&(r+="&p="+t.property.slice(1)),0!==t.iterations&&(r+="&depth="+t.iterations),"en"!==t.lang&&(r+="&lang="+t.lang),window.open(r)}}).call(this);