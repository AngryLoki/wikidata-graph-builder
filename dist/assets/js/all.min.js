(function(){var t,e,n,a,r,i,o,s,l,d,c,p,u,g;d=function(t){var e,n,a,r,i;i=[];for(a in t)r=t[a],"randomData"!==a&&(e=$("[name="+a+"]"),"lang"===a||"iterations"===a||"limit"===a?e.val()!==r?i.push(e.val(r)):i.push(void 0):"direction"===a?e.find(":selected").val()!==r.toLowerCase()?i.push(e.val(r.toLowerCase())):i.push(void 0):e.find(":selected").val()!==r?(n=$("<option selected />").val(r).text("Loading..."),e.append(n),e.trigger("change"),i.push(c(e,n,r))):i.push(void 0));return i},c=function(t,e,n){return $.getJSON("https://www.wikidata.org/w/api.php?callback=?",{action:"wbsearchentities",search:n,uselang:$("[name=lang]").val()||History.getState().data.lang||"en",language:$("[name=lang]").val()||History.getState().data.lang||"en",type:n.startsWith("Q")?"item":"property",format:"json",formatversion:2,limit:1}).then(function(a){var r;e.text((null!=(r=a.search)?r[0].label:void 0)||n),e.removeData(),t.trigger("change")})},n=function(t){return t.label||t.text},e=function(t){return'<div><div class="item-name">'+(t.label||t.text)+"</div>"+(t.description?'<div class="item-descrition">'+t.description+"</div>":"")+"</div>"},p=function(t,a,r){return t.select2({placeholder:r,theme:"bootstrap",ajax:{url:"https://www.wikidata.org/w/api.php",dataType:"jsonp",cache:!0,data:function(e){return{action:"wbsearchentities",search:e.term||t.val(),uselang:$("[name=lang]").val()||History.getState().data.lang||"en",language:$("[name=lang]").val()||History.getState().data.lang||"en",type:a,format:"json",formatversion:2,"continue":e.next||0}},processResults:function(t,e){return e.next=t["search-continue"],{results:t.search,pagination:{more:t["search-continue"]}}}},minimumInputLength:1,templateResult:e,templateSelection:n,escapeMarkup:function(t){return t}})},$(function(){var t;return $(".navbar-brand").attr("href",window.location.href.split("?")[0]),$("form").validate({errorPlacement:function(){},highlight:function(t){$(t).parent().addClass("has-error")},unhighlight:function(t){$(t).parent().removeClass("has-error")},rules:{item:{required:!0,regex:/^Q\d+$/},property:{required:!0,regex:/^P\d+$/},lang:{required:!0,minlength:2,regex:/^[a-z-]+$/}}}),$("form").on("submit",u),p($("select[name=item]"),"item","Item, e. g Q42196"),p($("select[name=property]"),"property","Property, e. g P171"),t=r(),History.replaceState(t),d(t),g(),History.Adapter.bind(window,"statechange",g),$("#openSparql").click(o),$("#openSvg").click(s),$("#openWdTree").click(l)}),t={property:"",item:"",lang:"en",direction:"Forward",iterations:0,limit:0},u=function(e){var n,a,r,i,o,s,l,d,c,p;if($("form").valid()){s=$(this).find("[name=property] :selected"),a=$(this).find("[name=item] :selected"),i=$(this).find("[name=lang]"),n=$(this).find("[name=direction]"),r=$(this).find("[name=iterations]"),o=$(this).find("[name=limit]"),l={randomData:Math.random(),property:s.val(),item:a.val(),lang:i.val(),direction:"reverse"===n.val()?"Reverse":"Forward",iterations:parseInt(r.val()),limit:parseInt(o.val())},c={};for(d in t)p=t[d],l[d]!==p&&(c[d]=l[d]);return c.direction&&(c.direction=c.direction.toLowerCase()),History.pushState(l,"","?"+$.param(c)),!1}},r=function(){var e,n,a,r,i,o;for(a=/\+/g,i=/([^&=]+)=?([^&]*)/g,e=function(t){return decodeURIComponent(t.replace(a," "))},r=window.location.search.substring(1),o={};n=i.exec(r);)o[e(n[1])]=e(n[2]);return{item:o.item||t.item,property:o.property||t.property,lang:o.lang||t.lang,direction:"reverse"===o.direction?"Reverse":"Forward",iterations:parseInt(o.iterations)||t.iterations,limit:parseInt(o.limit)||t.limit}},a=function(t){return'PREFIX wd: <http://www.wikidata.org/entity/>\nPREFIX wdt: <http://www.wikidata.org/prop/direct/>\nPREFIX wikibase: <http://wikiba.se/ontology#>\nPREFIX gas: <http://www.bigdata.com/rdf/gas#>\n\nSELECT ?item ?itemLabel ?parent {\n  { SERVICE gas:service {\n     gas:program gas:gasClass "com.bigdata.rdf.graph.analytics.SSSP" ;\n                 gas:in wd:'+t.item+' ;\n                 gas:traversalDirection "'+t.direction+'" ;\n                 gas:out ?item ;\n                 gas:out1 ?depth ;'+(0===t.iterations?"":"\n                 gas:maxIterations "+t.iterations+" ;")+(0===t.limit?"":"\n                 gas:maxVisited "+t.limit+" ;")+"\n                 gas:linkType wdt:"+t.property+" .\n    }\n  } .\n  OPTIONAL { ?item wdt:"+t.property+' ?parent }\n  SERVICE wikibase:label {bd:serviceParam wikibase:language "'+t.lang+'" }\n}'},i=function(t){var e,n,a,r,i,o,s,l,d,c,p,u,g,m,h,v,f,w,y,x,k;for(e=History.getState().data.item,n=t.results.bindings,g={},d=0,c=n.length;c>d;d++)s=n[d],g[s.item.value]={name:s.itemLabel.value,url:s.item.value};u=function(){var t,e,a,r;for(r=[],t=0,e=n.length;e>t;t++)s=n[t],g[null!=(a=s.parent)?a.value:void 0]&&r.push({source:g[s.item.value],target:g[s.parent.value]});return r}(),y=function(t){return"translate("+t.x+","+t.y+")"},w=function(){p.attr({x1:function(t){return t.source.x},y1:function(t){return t.source.y},x2:function(t){return t.target.x},y2:function(t){return t.target.y}}),a.attr({transform:y}),f.attr({transform:y})},m=function(){var t,e;e=window.innerWidth,t=window.innerHeight-$("nav").outerHeight()-10,h.attr({width:e,height:t}),o.attr({width:e,height:t}),l.size([e,t]).resume()},k=function(){r.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")},x=d3.behavior.zoom().on("zoom",k),l=d3.layout.force(),i=l.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}),l.nodes(d3.values(g)).links(u).linkDistance(30).charge(-200).gravity(.05).on("tick",w).start(),h=d3.select("svg").attr("pointer-events","all"),h.selectAll("*").remove(),h.append("defs").selectAll("marker").data(["direction"]).enter().append("marker").attr({id:function(t){return t},viewBox:"0 -5 10 10",refX:15,markerWidth:6,markerHeight:6,orient:"auto"}).append("path").attr({d:"M0,-5L10,0L0,5"}),v=h.append("g").attr("transform","translate(0,0)").call(x),o=v.append("rect").style("fill","none"),r=v.append("g"),p=r.append("g").selectAll("line").data(l.links()).enter().append("line").attr({"marker-end":"url(#direction)"}),a=r.append("g").selectAll("circle").data(l.nodes()).enter().append("circle").attr({r:6}).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).classed("active",function(t){return t.url.endsWith(e)}).call(i),f=r.append("g").selectAll("text").data(l.nodes()).enter().append("text").attr({x:8,y:".31em"}).text(function(t){return t.name}).on("click",function(t){window.open(t.url)}),m(),d3.select(window).on("resize",m)},$.validator.addMethod("regex",function(t,e,n){var a;return a=!1,this.optional(e)||n.test(t)},"Please check your input."),g=function(){var t,e,n;t=History.getState().data,d(t),e=a(t),t.item&&t.property?($("#main").hide(),$("svg").show(),n=(new Date).getTime(),$.getJSON("https://query.wikidata.org/sparql",{query:e},i).fail(function(t,e,a){var r;r=(new Date).getTime()-n,1e4>r?toastr.error("Something is wrong with SPARQL query syntax"):toastr.error("SPARQL query times out")})):($("#main").show(),$("svg").hide())},o=function(){var t,e;if($("form").valid())return t=History.getState().data,e=a(t),window.open("https://query.wikidata.org/#"+encodeURIComponent(e))},s=function(){var t,e,n;if($("form").valid())return t=new XMLSerializer,e=t.serializeToString($("svg")[0]),e='<?xml version="1.0" standalone="no"?>\r\n'+e,n="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e),window.open(n)},l=function(){var t,e;if($("form").valid())return t=History.getState().data,e="https://tools.wmflabs.org/wikidata-todo/tree.html?q="+t.item.slice(1),e+="&"+("Reverse"===t.direction?"rp":"p")+"="+t.property.slice(1),0!==t.iterations&&(e+="&depth="+t.iterations),"en"!==t.lang&&(e+="&lang="+t.lang),window.open(e)}}).call(this);