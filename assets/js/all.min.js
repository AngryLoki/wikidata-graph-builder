(function(){var t,e,n,r,a=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};n=function(t){var e,n;return(null!=(e=t.itemLabel)?e.value:void 0)||(null!=(n=t.item.value.match("^http://www.wikidata.org/entity/(.+)$"))?n[1]:void 0)||t.item.value},r=function(t){var e,r,i,o,u,l,s,c,d,p,f,v;if(i=a.call(t.head.vars,"size")>=0,e=t.results.bindings,p=1/0,d=0,f={},i)for(o=0,l=e.length;l>o;o++)r=e[o],f[r.item.value]||(v=parseInt(r.size.value),p>v&&(p=v),v>d&&(d=v),f[r.item.value]={name:n(r),url:r.item.value,hasLink:!!r.linkTo,size:v});else for(u=0,s=e.length;s>u;u++)r=e[u],f[r.item.value]={name:n(r),url:r.item.value,hasLink:!!r.linkTo};return c=function(){var t,n,a,i;for(i=[],t=0,n=e.length;n>t;t++)r=e[t],f[null!=(a=r.linkTo)?a.value:void 0]&&i.push({source:f[r.item.value],target:f[r.linkTo.value]});return i}(),{hasSize:i,nodes:f,links:c,minSize:p,maxSize:d}},e=function(t,e,n,a,i){var o,u,l,s,c,d,p,f,v,x,m,y,h,g,k,w,z,L,S,A,b,D,M,T,I,W,C,E,H,X,$,q,B,G,O;if(t.selectAll("*").remove(),d3.selectAll("#graph-tooltip").remove(),e&&e.head){if(b=r(e),v=b.hasSize,L=b.nodes,h=b.links,k=b.minSize,g=b.maxSize,v){q=i,M=[3,20],A=q?d3.scale.log().clamp(!0).domain([Math.max(1e-12,k),Math.max(1e-12,g)]).range(M):d3.scale.linear().domain([k,g]).range(M);for(z in L)w=L[z],w.radius=A(w.size)}T=t.append("svg").attr({xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink"}),E=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),X=function(t){return"translate("+t.x+","+t.y+")"},$=!1,C=function(t){var e,n,r,a,i,o,u,s,c,d;if($){a={},l.each(function(t){var e;e=t.name.toLowerCase()>"k",a[e]||(a[e]={x:0,y:0,s:0}),a[e].x+=t.x,a[e].y+=t.y,a[e].s++});for(r in a)u=a[r],a[r].x/=a[r].s,a[r].y/=a[r].s;i=6*t.alpha,l.each(function(t){r=t.name.toLowerCase()>"k",t.x=t.x*(1-i)+a[r].x*i,t.y=t.y*(1-i)+a[r].y*i,t.x<0&&(t.x+=-t.x*i),t.x>B&&(t.x-=(t.x-B)*i),t.y<0&&(t.y+=-t.y*i),t.y>x&&(t.y-=(t.y-x)*i)})}v?(o=function(t){var e,n;return e=t.x,n=t.y,Math.sqrt(e*e+n*n)},d=function(t,e){var n,r,a,i;return n=t.x,a=t.y,r=e.x,i=e.y,{x:n+r,y:a+i}},e=function(t,e){var n,r,a,i;return n=t.x,a=t.y,r=e.x,i=e.y,{x:n-r,y:a-i}},s=function(t,e){var n,r;return n=t.x,r=t.y,{x:n*e,y:r*e}},n=function(t,e){var n,r;return n=t.x,r=t.y,{x:n/e,y:r/e}},c=function(t,e){return s(t,e/o(t))},m.each(function(t){var n,r,a;return r=t.source,a=t.target,r.x===a.x&&r.y===a.y?(t.sp=r,void(t.tp=a)):(n=e(a,r),t.sp=d(r,c(n,r.radius)),void(t.tp=e(a,c(n,a.radius))))}).attr({x1:function(t){var e;return e=t.sp,e.x},y1:function(t){var e;return e=t.sp,e.y},x2:function(t){var e;return e=t.tp,e.x},y2:function(t){var e;return e=t.tp,e.y}})):m.attr({x1:function(t){var e;return e=t.source,e.x},y1:function(t){var e;return e=t.source,e.y},x2:function(t){var e;return e=t.target,e.x},y2:function(t){var e;return e=t.target,e.y}}),l.attr({transform:X}),W.attr({transform:X})},O=function(){s.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")},G=d3.behavior.zoom().on("zoom",O),p=d3.layout.force(),c=p.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}),y=$?1:30,u=$?-5e3:-200,f=.05,p.nodes(d3.values(L)).links(h).linkDistance(y).charge(u).gravity(f).on("tick",C).start(),T.attr("pointer-events","all"),T.selectAll("*").remove(),o=v?0:6,T.append("defs").selectAll("marker").data(["direction"]).enter().append("marker").attr({id:function(t){return t},viewBox:"0 -5 10 10",refX:10+o-1,markerWidth:6,markerHeight:6,orient:"auto"}).append("path").attr({d:"M0,-5L10,0L0,5"}),I=T.append("g").attr("transform","translate(0,0)").call(G),d=I.append("rect").style("fill","none"),s=I.append("g"),m=s.append("g").selectAll("line").data(p.links()).enter().append("line").attr({"marker-end":"url(#direction)"}),S=v?function(t){return t.radius}:6,l=s.append("g").selectAll("circle").data(p.nodes()).enter().append("circle").attr({r:S,cx:function(t){return t.x},cy:function(t){return t.y}}),H=v?function(t){return t.name+"<br/>Size: "+t.size}:function(t){return t.name},v&&l.on("mouseover",function(t){return E.transition().duration(100).style("opacity",.9),E.html(H(t)).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY+5+"px")}).on("mouseout",function(t){return E.transition().duration(200).style("opacity",0)}),"undirected"===a&&l.classed("linked",function(t){return t.hasLink}),l.classed("active",function(t){return t.url.endsWith(n)}),l.call(c),W=s.append("g").selectAll("text").data(p.nodes()).enter().append("text").attr({x:8,y:".31em"}).text(function(t){return t.name}).on("click",function(t){window.open(t.url)}),B=x=0,D=function(){var t;t=300,B=window.innerWidth-t,x=window.innerHeight,T.attr({width:B,height:x}),d.attr({width:B,height:x}),p.size([B,x]).resume()},D(),d3.select(window).on("resize",D)}},t=angular.module("Graph",[]),t.directive("graph",function(){return{restrict:"E",replace:!1,scope:{graphData:"=",activeItem:"=",mode:"=",sizeLogScale:"="},link:function(t,n,r){t.$watch("graphData",function(r,a){var i;return i=d3.select(n[0]),e(i,t.graphData,t.activeItem,t.mode,t.sizeLogScale)})}}})}).call(this);
(function(){var e,i;e=angular.module("SparqlGen",[]),i=function(){var e,i,t;e=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},t=function(e){return 0!==e.limit||0!==e.iterations||"undirected"===e.mode},i=function(n,r){return null==r&&(r=n.mode),"both"===r?"{ "+i(n,"forward")+" } UNION { "+i(n,"reverse")+" }":t(n)?'SERVICE gas:service {\n    gas:program gas:gasClass "com.bigdata.rdf.graph.analytics.SSSP" ;\n                gas:in wd:'+n.item+' ;\n                gas:traversalDirection "'+e(r)+'" ;\n                gas:out ?item ;\n                gas:out1 ?depth ;'+(0===n.iterations?"":"\n                gas:maxIterations "+n.iterations+" ;")+(0===n.limit?"":"\n                gas:maxVisited "+n.limit+" ;")+"\n                gas:linkType wdt:"+n.property+" .\n  }":"forward"===r?"wd:"+n.item+" wdt:"+n.property+"* ?item":"reverse"===r?"?item wdt:"+n.property+"* wd:"+n.item:void 0},this.generate=function(e){var n;if(e.item&&e.property)return n=t(e)?"PREFIX gas: <http://www.bigdata.com/rdf/gas#>\n\n":"",e.size_property?n+("SELECT ?item ?itemLabel ?linkTo ?size {\n  { SELECT ?item (count(distinct ?element) as ?size) {\n  "+i(e)+"\n  OPTIONAL { ?element wdt:"+e.size_property+(e.size_recursive?"*":"")+" ?item }\n  } GROUP BY ?item }\n  OPTIONAL { ?item wdt:"+e.property+' ?linkTo }\n  SERVICE wikibase:label {bd:serviceParam wikibase:language "'+e.lang+'" }\n}'):n+("SELECT ?item ?itemLabel ?linkTo {\n  "+i(e)+"\n  OPTIONAL { ?item wdt:"+e.property+' ?linkTo }\n  SERVICE wikibase:label {bd:serviceParam wikibase:language "'+e.lang+'" }\n}')}},i.$inject=[],e.service("SparqlGenService",i)}).call(this);
(function(){var t,e;t=angular.module("WikiTools",[]),e=function(t,e,i){var r;r=i({format:"json",formatversion:2,callback:"JSON_CALLBACK"}),this.createApi=function(t,e){var i;return e||(i=["www",t],t=i[0],e=i[1]),"https://"+t+"."+e+".org/w/api.php?"+r},this.wikidata=this.createApi("wikidata"),this.get=function(t,i){return e.jsonp(t,{params:i})},this.searchEntities=function(e){return function(i,r,a){var n,s,u;return s={action:"wbsearchentities",search:r,uselang:a,language:a,type:i,"continue":0},u=function(t){return t.data.search},n=function(e){return t.error("Request failed"),reject("Request failed")},e.get(e.wikidata,s).then(u,n)}}(this),this.getEntity=function(e){return function(i,r){var a,n,s;return n={action:"wbsearchentities",search:i,uselang:r,language:r,type:i.startsWith("Q")?"item":"property",limit:1},s=function(t){var e;return t.data.search?(e=t.data.search[0],e.lang=r,e):{id:i,label:i,lang:r}},a=function(e){return t.error("Request failed"),reject("Request failed")},e.get(e.wikidata,n).then(s,a)}}(this),this.wdqs=function(t){return e.get("https://query.wikidata.org/sparql",{params:{query:t}})}},e.$inject=["$log","$http","$httpParamSerializer"],t.service("WikiToolsService",e)}).call(this);
(function(){var t,e;t=function(t,e,n,r,i,o,a,s){var u,c,d,l,h,p,f,m;this.modes={forward:"Forward",reverse:"Reverse",both:"Bidirectional",undirected:"Undirected",wdqs:"WDQS"},d={property:{type:"property"},item:{type:"item"},lang:{type:"lang","default":"en"},iterations:{type:"number","default":0},limit:{type:"number","default":0},mode:{type:"enum",values:this.modes,"default":"forward",extractor:function(t){return t.mode||t.direction}},wdqs:{type:"text"},size_property:{type:"property"},size_recursive:{type:"boolean"},size_log_scale:{type:"boolean"}},l=function(){var t,e,r,i,o;i=n.search(),t={};for(e in d)o=d[e],r=o.extractor?o.extractor(i):i[e],t[e]=function(){switch(o.type){case"property":return/^P\d+$/.test(r||"")?r:o["default"];case"item":return/^Q\d+$/.test(r||"")?r:o["default"];case"lang":return/^[a-z-]{2,}$/.test(r||"")?r:o["default"];case"number":return/^\d+$/.test(r||"")?parseInt(r):o["default"];case"text":return r||o["default"];case"enum":return o.values[r]?r:o["default"];case"boolean":return 1===r||r===!0||"1"===r||"true"===r}}();return t.wdqs||(t.wdqs=s.generate(t)),t},u=function(){var t,e;e=[];for(h in d)m=d[h],"item"!==(t=m.type)&&"property"!==t||e.push(h);return e}(),u.forEach(function(e){return function(n){return t.$watch(function(){return e[n]},function(t){return t?a.getEntity(t,e.lang).then(function(t){return e[n+"Object"]=t}):e[n+"Object"]=e[n+"Text"]=void 0})}}(this)),t.$watch(function(t){return function(){return t.lang}}(this),function(t){return function(e){return e?u.forEach(function(n){var r;return r=n+"Object",t[r]&&t[r].lang!==e?(t[r].lang=e,a.getEntity(t[r].id,e).then(function(n){return t[r].lang===e?t[r]=n:void 0})):void 0}):void 0}}(this)),p=function(t){return function(){var e,n;e=l();for(h in e)m=e[h],t[h]=m,m||"item"!==(n=d[h].type)&&"property"!==n||(t[h+"Object"]=t[h+"Text"]=void 0);t.validate()||(t.graphData=void 0),e.wdqs&&f(e)}}(this),r.$on("$locationChangeSuccess",p),this.itemSearch=function(t){return a.searchEntities("item",t,this.lang)},this.propertySearch=function(t){return a.searchEntities("property",t,this.lang)},this.reset=function(){return n.search({})},this.validate=function(){return"wdqs"===this.mode&&this.wdqs||"wdqs"!==this.mode&&this.lang&&this.itemObject&&this.propertyObject},this.submit=function(){var t,e,r,i,o;if(t={},"wdqs"===this.mode)t.mode="wdqs",t.wdqs=this.wdqs;else for(e in d)o=d[e],"wdqs"!==e&&("item"===(r=o.type)||"property"===r?t[e]=(null!=(i=this[e+"Object"])?i.id:void 0)||o["default"]:"boolean"===o.type?this[e]!==!!o["default"]&&(t[e]=~~this[e]):this[e]!==o["default"]&&(t[e]=this[e]));return JSON.stringify(n.search())===JSON.stringify(t)?p():n.search(t)},c=function(t,e){var n;return n=i.simple().textContent(t).hideDelay(5e3),e&&n.action("More info").highlightAction(!0),n=i.show(n).then(function(n){return function(n){var r;return e&&"ok"===n?(r=angular.element("<md-dialog />").attr("aria-label",t).append(angular.element("<pre />").text(e)),o.show({clickOutsideToClose:!0,template:r[0].outerHTML})):void 0}}(this))},f=function(t){return function(n){var r,i,o,s;o=n.wdqs,s=(new Date).getTime(),i=function(e){return t.isLoading=!1,t.activeItem=n.item,t.graphData=e.data},r=function(n){var r;t.isLoading=!1,e.error("unable to process answer",n.data),r=(new Date).getTime()-s,1e4>r?c("Something is wrong with SPARQL query syntax",n.data):c("SPARQL query times out")},t.isLoading=!0,a.wdqs(o).then(i,r),t.showSvg=!0}}(this),this.query=function(){var t;t=l(),window.open("https://query.wikidata.org/#"+encodeURIComponent(t.wdqs))},this.svg=function(){var t,e,n;t=new XMLSerializer,e=t.serializeToString($("svg")[0]),e='<?xml version="1.0" standalone="no"?>\r\n'+e,n="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e),window.open(n)},this.list=function(){var t,e,n,r;t=l(),r="https://tools.wmflabs.org/wikidata-todo/tree.html?q="+t.item.slice(1),"reverse"!==(e=t.mode)&&"both"!==e||(r+="&rp="+t.property.slice(1)),"forward"!==(n=t.mode)&&"both"!==n||(r+="&p="+t.property.slice(1)),0!==t.iterations&&(r+="&depth="+t.iterations),"en"!==t.lang&&(r+="&lang="+t.lang),window.open(r)}},t.$inject=["$scope","$log","$location","$rootScope","$mdToast","$mdDialog","WikiToolsService","SparqlGenService"],e=angular.module("WgbApp",["ngMaterial","WikiTools","Graph","SparqlGen"]),e.config(["$locationProvider",function(t){t.html5Mode({enabled:!0,requireBase:!1})}]),e.controller("FormCtrl",t)}).call(this);