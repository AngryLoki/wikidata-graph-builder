(function(){var e,t,a,n,r,i,o,s,l,d,c,p,u,g;d=function(e){var t,a,n,r,i;i=[];for(n in e)r=e[n],"randomData"!==n&&(t=$("[name="+n+"]"),"lang"===n||"iterations"===n||"limit"===n?t.val()!==r?i.push(t.val(r)):i.push(void 0):"direction"===n?t.find(":selected").val()!==r.toLowerCase()?i.push(t.val(r.toLowerCase())):i.push(void 0):t.find(":selected").val()!==r?(a=$("<option selected />").val(r).text("Loading..."),t.append(a),t.trigger("change"),i.push(c(t,a,r))):i.push(void 0));return i},c=function(e,t,a){return $.getJSON("https://www.wikidata.org/w/api.php?callback=?",{action:"wbsearchentities",search:a,uselang:$("[name=lang]").val()||History.getState().data.lang||"en",language:$("[name=lang]").val()||History.getState().data.lang||"en",type:a.startsWith("Q")?"item":"property",format:"json",formatversion:2,limit:1}).then(function(n){var r;t.text((null!=(r=n.search)?r[0].label:void 0)||a),t.removeData(),e.trigger("change")})},a=function(e){return e.label||e.text},t=function(e){return'<div><div class="item-name">'+(e.label||e.text)+"</div>"+(e.description?'<div class="item-descrition">'+e.description+"</div>":"")+"</div>"},p=function(e,n,r){return e.select2({placeholder:r,theme:"bootstrap",ajax:{url:"https://www.wikidata.org/w/api.php",dataType:"jsonp",cache:!0,data:function(t){return{action:"wbsearchentities",search:t.term||e.val(),uselang:$("[name=lang]").val()||History.getState().data.lang||"en",language:$("[name=lang]").val()||History.getState().data.lang||"en",type:n,format:"json",formatversion:2,"continue":t.next||0}},processResults:function(e,t){return t.next=e["search-continue"],{results:e.search,pagination:{more:e["search-continue"]}}}},minimumInputLength:1,templateResult:t,templateSelection:a,escapeMarkup:function(e){return e}})},$(function(){var e;return $(".navbar-brand").attr("href",window.location.href.split("?")[0]),$("form").validate({errorPlacement:function(){},highlight:function(e){$(e).parent().addClass("has-error")},unhighlight:function(e){$(e).parent().removeClass("has-error")},rules:{item:{required:!0,regex:/^Q\d+$/},property:{required:!0,regex:/^P\d+$/},lang:{required:!0,minlength:2,regex:/^[a-z-]+$/}}}),$("form").on("submit",u),p($("select[name=item]"),"item","Item, e. g Q42196"),p($("select[name=property]"),"property","Property, e. g P171"),e=r(),History.replaceState(e),d(e),g(),History.Adapter.bind(window,"statechange",g),$("#openSparql").click(o),$("#openSvg").click(s),$("#openWdTree").click(l)}),e={property:"",item:"",lang:"en",direction:"Forward",iterations:0,limit:0},u=function(t){var a,n,r,i,o,s,l,d,c,p;if($("form").valid()){s=$(this).find("[name=property] :selected"),n=$(this).find("[name=item] :selected"),i=$(this).find("[name=lang]"),a=$(this).find("[name=direction]"),r=$(this).find("[name=iterations]"),o=$(this).find("[name=limit]"),l={randomData:Math.random(),property:s.val(),item:n.val(),lang:i.val(),direction:"reverse"===a.val()?"Reverse":"Forward",iterations:parseInt(r.val()),limit:parseInt(o.val())},c={};for(d in e)p=e[d],l[d]!==p&&(c[d]=l[d]);return c.direction&&(c.direction=c.direction.toLowerCase()),History.pushState(l,"","?"+$.param(c)),!1}},r=function(){var t,a,n,r,i,o;for(n=/\+/g,i=/([^&=]+)=?([^&]*)/g,t=function(e){return decodeURIComponent(e.replace(n," "))},r=window.location.search.substring(1),o={};a=i.exec(r);)o[t(a[1])]=t(a[2]);return{item:o.item||e.item,property:o.property||e.property,lang:o.lang||e.lang,direction:"reverse"===o.direction?"Reverse":"Forward",iterations:parseInt(o.iterations)||e.iterations,limit:parseInt(o.limit)||e.limit}},n=function(e){return'PREFIX wd: <http://www.wikidata.org/entity/>\nPREFIX wdt: <http://www.wikidata.org/prop/direct/>\nPREFIX wikibase: <http://wikiba.se/ontology#>\nPREFIX gas: <http://www.bigdata.com/rdf/gas#>\n\nSELECT ?item ?itemLabel ?parent {\n  { SERVICE gas:service {\n     gas:program gas:gasClass "com.bigdata.rdf.graph.analytics.SSSP" ;\n                 gas:in wd:'+e.item+' ;\n                 gas:traversalDirection "'+e.direction+'" ;\n                 gas:out ?item ;\n                 gas:out1 ?depth ;'+(0===e.iterations?"":"\n                 gas:maxIterations "+e.iterations+" ;")+(0===e.limit?"":"\n                 gas:maxVisited "+e.limit+" ;")+"\n                 gas:linkType wdt:"+e.property+" .\n    }\n  } .\n  OPTIONAL { ?item wdt:"+e.property+' ?parent }\n  SERVICE wikibase:label {bd:serviceParam wikibase:language "'+e.lang+'" }\n}'},i=function(e){var t,a,n,r,i,o,s,l,d,c,p,u,g,m,h,v;for(t=History.getState().data.item,a=e.results.bindings,c={},o=0,s=a.length;s>o;o++)r=a[o],c[r.item.value]={name:r.itemLabel.value,url:r.item.value};d=function(){var e,t,n,i;for(i=[],e=0,t=a.length;t>e;e++)r=a[e],c[null!=(n=r.parent)?n.value:void 0]&&i.push({source:c[r.item.value],target:c[r.parent.value]});return i}(),l=function(e){return"M"+e.source.x+","+e.source.y+"A0,0 0 0,1 "+e.target.x+","+e.target.y},v=function(e){return"translate("+e.x+","+e.y+")"},h=function(){p.attr({d:l}),n.attr({transform:v}),m.attr({transform:v})},u=function(){var e,t;t=window.innerWidth,e=window.innerHeight-$("nav").outerHeight()-10,g.attr({width:t,height:e}),i.size([t,e]).resume()},i=d3.layout.force().nodes(d3.values(c)).links(d).linkDistance(30).charge(-200).gravity(.05).on("tick",h).start(),g=d3.select("svg"),g.selectAll("*").remove(),g.append("defs").selectAll("marker").data(["direction"]).enter().append("marker").attr({id:function(e){return e},viewBox:"0 -5 10 10",refX:15,refY:-1.5,markerWidth:6,markerHeight:6,orient:"auto"}).append("path").attr({d:"M0,-5L10,0L0,5"}),p=g.append("g").selectAll("path").data(i.links()).enter().append("path").attr({"class":"link","marker-end":"url(#direction)"}),n=g.append("g").selectAll("circle").data(i.nodes()).enter().append("circle").attr({r:6}).classed("active",function(e){return e.url.endsWith(t)}).call(i.drag),m=g.append("g").selectAll("text").data(i.nodes()).enter().append("text").attr({x:8,y:".31em"}).text(function(e){return e.name}).on("click",function(e){window.open(e.url)}),u(),d3.select(window).on("resize",u)},$.validator.addMethod("regex",function(e,t,a){var n;return n=!1,this.optional(t)||a.test(e)},"Please check your input."),g=function(){var e,t,a;e=History.getState().data,d(e),t=n(e),e.item&&e.property?($("#main").hide(),$("svg").show(),a=(new Date).getTime(),$.getJSON("https://query.wikidata.org/sparql",{query:t},i).fail(function(e,t,n){var r;r=(new Date).getTime()-a,1e4>r?toastr.error("Something is wrong with SPARQL query syntax"):toastr.error("SPARQL query times out")})):($("#main").show(),$("svg").hide())},o=function(){var e,t;if($("form").valid())return e=History.getState().data,t=n(e),window.open("https://query.wikidata.org/#"+encodeURIComponent(t))},s=function(){var e,t,a;if($("form").valid())return e=new XMLSerializer,t=e.serializeToString($("svg")[0]),t='<?xml version="1.0" standalone="no"?>\r\n'+t,a="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(t),window.open(a)},l=function(){var e,t;if($("form").valid())return e=History.getState().data,t="https://tools.wmflabs.org/wikidata-todo/tree.html?q="+e.item.slice(1),t+="&"+("Reverse"===e.direction?"rp":"p")+"="+e.property.slice(1),0!==e.iterations&&(t+="&depth="+e.iterations),"en"!==e.lang&&(t+="&lang="+e.lang),window.open(t)}}).call(this);