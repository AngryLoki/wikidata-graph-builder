(function(){var t,e,a,n,r,i,o,s,l,d,c,p,u,g;d=function(t){var e,a,n,r,i;i=[];for(n in t)r=t[n],"randomData"!==n&&(e=$("[name="+n+"]"),"lang"===n||"iterations"===n||"limit"===n?e.val()!==r?i.push(e.val(r)):i.push(void 0):"direction"===n?e.find(":selected").val()!==r.toLowerCase()?i.push(e.val(r.toLowerCase())):i.push(void 0):e.find(":selected").val()!==r?(a=$("<option selected />").val(r).text("Loading..."),e.append(a),e.trigger("change"),i.push(c(e,a,r))):i.push(void 0));return i},c=function(t,e,a){return $.getJSON("https://www.wikidata.org/w/api.php?callback=?",{action:"wbsearchentities",search:a,uselang:$("[name=lang]").val()||History.getState().data.lang||"en",language:$("[name=lang]").val()||History.getState().data.lang||"en",type:a.startsWith("Q")?"item":"property",format:"json",formatversion:2,limit:1}).then(function(n){var r;e.text((null!=(r=n.search)?r[0].label:void 0)||a),e.removeData(),t.trigger("change")})},a=function(t){return t.label||t.text},e=function(t){return'<div><div class="item-name">'+(t.label||t.text)+"</div>"+(t.description?'<div class="item-descrition">'+t.description+"</div>":"")+"</div>"},p=function(t,n,r){return t.select2({placeholder:r,theme:"bootstrap",ajax:{url:"https://www.wikidata.org/w/api.php",dataType:"jsonp",cache:!0,data:function(e){return{action:"wbsearchentities",search:e.term||t.val(),uselang:$("[name=lang]").val()||History.getState().data.lang||"en",language:$("[name=lang]").val()||History.getState().data.lang||"en",type:n,format:"json",formatversion:2,"continue":e.next||0}},processResults:function(t,e){return e.next=t["search-continue"],{results:t.search,pagination:{more:t["search-continue"]}}}},minimumInputLength:1,templateResult:e,templateSelection:a,escapeMarkup:function(t){return t}})},$(function(){var t;return $(".navbar-brand").attr("href",window.location.href.split("?")[0]),$("form").validate({errorPlacement:function(){},highlight:function(t){$(t).parent().addClass("has-error")},unhighlight:function(t){$(t).parent().removeClass("has-error")},rules:{item:{required:!0,regex:/^Q\d+$/},property:{required:!0,regex:/^P\d+$/},lang:{required:!0,minlength:2,regex:/^[a-z-]+$/}}}),$("form").on("submit",u),p($("select[name=item]"),"item","Item, e. g Q42196"),p($("select[name=property]"),"property","Property, e. g P171"),t=r(),History.replaceState(t),d(t),g(),History.Adapter.bind(window,"statechange",g),$("#openSparql").click(o),$("#openSvg").click(s),$("#openWdTree").click(l)}),t={property:"",item:"",lang:"en",direction:"Forward",iterations:0,limit:0},u=function(e){var a,n,r,i,o,s,l,d,c,p;if($("form").valid()){s=$(this).find("[name=property] :selected"),n=$(this).find("[name=item] :selected"),i=$(this).find("[name=lang]"),a=$(this).find("[name=direction]"),r=$(this).find("[name=iterations]"),o=$(this).find("[name=limit]"),l={randomData:Math.random(),property:s.val(),item:n.val(),lang:i.val(),direction:"reverse"===a.val()?"Reverse":"Forward",iterations:parseInt(r.val()),limit:parseInt(o.val())},c={};for(d in t)p=t[d],l[d]!==p&&(c[d]=l[d]);return c.direction&&(c.direction=c.direction.toLowerCase()),History.pushState(l,"","?"+$.param(c)),!1}},r=function(){var e,a,n,r,i,o;for(n=/\+/g,i=/([^&=]+)=?([^&]*)/g,e=function(t){return decodeURIComponent(t.replace(n," "))},r=window.location.search.substring(1),o={};a=i.exec(r);)o[e(a[1])]=e(a[2]);return{item:o.item||t.item,property:o.property||t.property,lang:o.lang||t.lang,direction:"reverse"===o.direction?"Reverse":"Forward",iterations:parseInt(o.iterations)||t.iterations,limit:parseInt(o.limit)||t.limit}},n=function(t){return'PREFIX wd: <http://www.wikidata.org/entity/>\nPREFIX wdt: <http://www.wikidata.org/prop/direct/>\nPREFIX wikibase: <http://wikiba.se/ontology#>\nPREFIX gas: <http://www.bigdata.com/rdf/gas#>\n\nSELECT ?item ?itemLabel ?parent {\n  { SERVICE gas:service {\n     gas:program gas:gasClass "com.bigdata.rdf.graph.analytics.SSSP" ;\n                 gas:in wd:'+t.item+' ;\n                 gas:traversalDirection "'+t.direction+'" ;\n                 gas:out ?item ;\n                 gas:out1 ?depth ;'+(0===t.iterations?"":"\n                 gas:maxIterations "+t.iterations+" ;")+(0===t.limit?"":"\n                 gas:maxVisited "+t.limit+" ;")+"\n                 gas:linkType wdt:"+t.property+" .\n    }\n  } .\n  OPTIONAL { ?item wdt:"+t.property+' ?parent }\n  SERVICE wikibase:label {bd:serviceParam wikibase:language "'+t.lang+'" }\n}'},i=function(t){var e,a,n,r,i,o,s,l,d,c,p,u,g,m,h,v,f,w,y,k,x,S;for(e=History.getState().data.item,a=t.results.bindings,g={},d=0,c=a.length;c>d;d++)s=a[d],g[s.item.value]={name:s.itemLabel.value,url:s.item.value};u=function(){var t,e,n,r;for(r=[],t=0,e=a.length;e>t;t++)s=a[t],g[null!=(n=s.parent)?n.value:void 0]&&r.push({source:g[s.item.value],target:g[s.parent.value]});return r}(),p=function(t){return"M"+t.source.x+","+t.source.y+"A0,0 0 0,1 "+t.target.x+","+t.target.y},k=function(t){return"translate("+t.x+","+t.y+")"},y=function(){m.attr({d:p}),n.attr({transform:k}),w.attr({transform:k})},h=function(){var t,e;e=window.innerWidth,t=window.innerHeight-$("nav").outerHeight()-10,v.attr({width:e,height:t}),o.attr({width:e,height:t}),l.size([e,t]).resume()},S=function(){r.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")},x=d3.behavior.zoom().on("zoom",S),l=d3.layout.force(),i=l.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}),l.nodes(d3.values(g)).links(u).linkDistance(30).charge(-200).gravity(.05).on("tick",y).start(),v=d3.select("svg").attr("pointer-events","all"),v.selectAll("*").remove(),v.append("defs").selectAll("marker").data(["direction"]).enter().append("marker").attr({id:function(t){return t},viewBox:"0 -5 10 10",refX:15,refY:-1.5,markerWidth:6,markerHeight:6,orient:"auto"}).append("path").attr({d:"M0,-5L10,0L0,5"}),f=v.append("g").attr("transform","translate(0,0)").call(x),o=f.append("rect").style("fill","none"),r=f.append("g"),m=r.append("g").selectAll("path").data(l.links()).enter().append("path").attr({"class":"link","marker-end":"url(#direction)"}),n=r.append("g").selectAll("circle").data(l.nodes()).enter().append("circle").attr({r:6}).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).classed("active",function(t){return t.url.endsWith(e)}).call(i),w=r.append("g").selectAll("text").data(l.nodes()).enter().append("text").attr({x:8,y:".31em"}).text(function(t){return t.name}).on("click",function(t){window.open(t.url)}),h(),d3.select(window).on("resize",h)},$.validator.addMethod("regex",function(t,e,a){var n;return n=!1,this.optional(e)||a.test(t)},"Please check your input."),g=function(){var t,e,a;t=History.getState().data,d(t),e=n(t),t.item&&t.property?($("#main").hide(),$("svg").show(),a=(new Date).getTime(),$.getJSON("https://query.wikidata.org/sparql",{query:e},i).fail(function(t,e,n){var r;r=(new Date).getTime()-a,1e4>r?toastr.error("Something is wrong with SPARQL query syntax"):toastr.error("SPARQL query times out")})):($("#main").show(),$("svg").hide())},o=function(){var t,e;if($("form").valid())return t=History.getState().data,e=n(t),window.open("https://query.wikidata.org/#"+encodeURIComponent(e))},s=function(){var t,e,a;if($("form").valid())return t=new XMLSerializer,e=t.serializeToString($("svg")[0]),e='<?xml version="1.0" standalone="no"?>\r\n'+e,a="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e),window.open(a)},l=function(){var t,e;if($("form").valid())return t=History.getState().data,e="https://tools.wmflabs.org/wikidata-todo/tree.html?q="+t.item.slice(1),e+="&"+("Reverse"===t.direction?"rp":"p")+"="+t.property.slice(1),0!==t.iterations&&(e+="&depth="+t.iterations),"en"!==t.lang&&(e+="&lang="+t.lang),window.open(e)}}).call(this);